/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements. 
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.ml_bundle_jsonpfunction=window.ml_bundle_jsonpfunction||[]).push([[3],{104:function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var r=n(5),a=n.n(r),i=n(46),o=n(122),l=n(128),s=n(76),c=n(223);class NewJobCapsService extends c.a{constructor(...e){super(...e),a()(this,"_catFields",[]),a()(this,"_dateFields",[]),a()(this,"_includeEventRateField",!0),a()(this,"_removeTextFields",!0)}get catFields(){return this._catFields}get dateFields(){return this._dateFields}get categoryFields(){return Object(l.b)(this._fields)}async initializeFromDataVIew(e,t=!0,n=!0){try{this._includeEventRateField=t,this._removeTextFields=n;const r=await s.ml.jobs.newJobCaps(e.title,"rollup"===e.type),{fields:a,aggs:l}=function(e,t){const n=e[t],r=[],a=[],i={},o={};return void 0!==n&&(n.aggs.forEach((e=>{const t={...e,...void 0!==e.fieldIds?{fields:[]}:{}};i[t.id]=t,a.push(t)})),n.fields.forEach((e=>{const t={...e,aggs:[]};void 0!==t.aggIds&&(o[t.id]=t.aggIds),r.push(t)})),r.forEach((e=>{o[e.id].forEach((t=>{!function(e,t){void 0===t.fields&&(t.fields=[]),void 0===e.aggs&&(e.aggs=[]),t.fields.push(e),e.aggs.push(t)}(e,i[t])}))}))),r.forEach((e=>delete e.aggIds)),a.forEach((e=>delete e.fieldIds)),{fields:r,aggs:a}}(r,e.title);!0===this._includeEventRateField&&function(e,t){const n={id:o.a,name:"Event rate",type:i.ES_FIELD_TYPES.INTEGER,aggregatable:!0,aggs:[]};e.forEach((e=>{void 0!==n.aggs&&void 0===e.fields&&(e.fields=[n],n.aggs.push(e))})),t.splice(0,0,n)}(l,a);const{fieldsPreferringKeyword:u,fieldsPreferringText:d}=Object(c.b)(a),f=d.filter((e=>e.type===i.ES_FIELD_TYPES.KEYWORD||e.type===i.ES_FIELD_TYPES.TEXT)),b=d.filter((e=>e.type===i.ES_FIELD_TYPES.DATE)),_=this._removeTextFields?u:a;this._fields=_,this._catFields=f,this._dateFields=b,this._aggs=l}catch(e){console.error("Unable to load new job capabilities",e)}}}const u=new NewJobCapsService},128:function(e,t,n){"use strict";n.d(t,"a",(function(){return l})),n.d(t,"c",(function(){return c})),n.d(t,"b",(function(){return u}));var r=n(30),a=n(122),i=n(96);const o=[r.ES_FIELD_TYPES.TEXT,r.ES_FIELD_TYPES.KEYWORD,r.ES_FIELD_TYPES.IP,r.ES_FIELD_TYPES.VERSION];function l(e,t,n){const o=function(e){return e.filter((e=>e.type===r.ES_FIELD_TYPES.KEYWORD||e.type===r.ES_FIELD_TYPES.VERSION))}(e),l=function(e){return e.filter((e=>e.type===r.ES_FIELD_TYPES.TEXT))}(e),c=function(e){return e.filter((e=>e.type===r.ES_FIELD_TYPES.LONG||e.type===r.ES_FIELD_TYPES.UNSIGNED_LONG||e.type===r.ES_FIELD_TYPES.INTEGER||e.type===r.ES_FIELD_TYPES.SHORT||e.type===r.ES_FIELD_TYPES.BYTE||e.type===r.ES_FIELD_TYPES.DOUBLE||e.type===r.ES_FIELD_TYPES.FLOAT||e.type===r.ES_FIELD_TYPES.HALF_FLOAT||e.type===r.ES_FIELD_TYPES.SCALED_FLOAT))}(e),u=function(e){return e.filter((e=>e.type===r.ES_FIELD_TYPES.IP))}(e),d=function(e){return e.filter((e=>e.type===r.ES_FIELD_TYPES.GEO_POINT||e.type===r.ES_FIELD_TYPES.GEO_SHAPE))}(e),f=Object.keys(n).length>0,b=function(e,t){return function(n,r){(!1===e||t[n.id]&&t[n.id].find((e=>e.agg===r.dslName)))&&(void 0!==n.aggs&&n.aggs.push(r),void 0!==r.fields&&r.fields.push(n))}}(f,n);return t.forEach((e=>{if(e.type===a.b&&void 0!==e.fields)switch(e.id){case i.b.LAT_LONG:d.forEach((t=>b(t,e)));break;case i.b.INFO_CONTENT:case i.b.HIGH_INFO_CONTENT:case i.b.LOW_INFO_CONTENT:l.forEach((t=>b(t,e)));case i.b.DISTINCT_COUNT:case i.b.HIGH_DISTINCT_COUNT:case i.b.LOW_DISTINCT_COUNT:o.forEach((t=>b(t,e))),u.forEach((t=>b(t,e)));default:c.forEach((t=>{b(t,e)}))}})),{aggs:t,fields:f?s(e):e}}function s(e){return e.filter((e=>e.aggs&&(e.aggs.length>0||0===e.aggs.length&&e.type===r.ES_FIELD_TYPES.DATE)))}function c(e){if(0===e.length)return e;let t;return e[0].id===a.a&&([t]=e.splice(0,1)),e.sort(((e,t)=>e.name.localeCompare(t.name))),void 0!==t&&e.splice(0,0,t),e}function u(e,t=!0){return e.filter((e=>o.includes(e.type)===t))}},142:function(e,t,n){"use strict";n.d(t,"c",(function(){return i})),n.d(t,"b",(function(){return o})),n.d(t,"a",(function(){return l}));var r=n(122),a=n(83);function i(){return{job_id:"",description:"",groups:[],analysis_config:{bucket_span:"",detectors:[],influencers:[]},data_description:{time_field:""}}}function o(e){return{datafeed_id:"",job_id:"",indices:Object(a.s)(e),query:{}}}function l(e,t){const n={function:e.id};return t.id!==r.a&&(n.field_name=t.id),n}},190:function(e,t,n){"use strict";n.d(t,"c",(function(){return u})),n.d(t,"d",(function(){return d})),n.d(t,"b",(function(){return f})),n.d(t,"a",(function(){return b}));var r=n(8),a=n(130),i=n(46),o=n(112),l=n(98);const s={bool:{must:[{match_all:{}}]}},c={query:"",language:"lucene"};function u(){return Object(r.cloneDeep)(s)}function d(){return Object(r.cloneDeep)(c)}function f(e,t,n){return null===n?{query:d(),combinedQuery:u()}:b(Object(l.f)(n),t,e)}function b(e,t,n){let r=d(),l=u();r=e.query;const s=e.filter,c=Array.isArray(s)?s:[];if(r.language===o.c.KUERY){const e=Object(a.e)(r.query);""!==r.query&&(l=Object(a.h)(e,t));const n=Object(a.b)(c,t);void 0===l.bool&&(l.bool={},void 0!==l.multi_match&&(l.bool.should={multi_match:l.multi_match},delete l.multi_match)),!1===Array.isArray(l.bool.filter)&&(l.bool.filter=void 0===l.bool.filter?[]:[l.bool.filter]),!1===Array.isArray(l.bool.must_not)&&(l.bool.must_not=void 0===l.bool.must_not?[]:[l.bool.must_not]),l.bool.filter=[...l.bool.filter,...n.filter],l.bool.must_not=[...l.bool.must_not,...n.must_not]}else{const e=Object(i.getEsQueryConfig)(n);l=Object(a.a)(t,[r],c,e)}return{query:r,combinedQuery:l}}},274:function(e,t,n){"use strict";n.r(t),n.d(t,"resolver",(function(){return h})),n.d(t,"getResultLayersFromEmbeddable",(function(){return O})),n.d(t,"convertLensToADJob",(function(){return w})),n.d(t,"getJobsItemsFromEmbeddable",(function(){return E})),n.d(t,"isCompatibleVisualizationType",(function(){return m}));var r=n(57),a=n.n(r),i=n(8),o=n(66),l=n(2),s=n(142),c=n(95),u=n(85),d=n(190),f=n(46),b=n(96);const _=["line","bar","bar_stacked","bar_percentage_stacked","bar_horizontal","bar_horizontal_stacked","area","area_stacked","area_percentage_stacked"],y=o.layerTypes.DATA,g=[f.KBN_FIELD_TYPES.STRING,f.KBN_FIELD_TYPES.IP];function E(e){const{query:t,filters:n,timeRange:r}=e.getInput();if(void 0===r)throw Error(l.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.noTimeRange",{defaultMessage:"Time range not specified."}));const{to:a,from:i}=r,o=e.getSavedVis();if(void 0===o)throw Error(l.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.visNotFound",{defaultMessage:"Visualization cannot be found."}));return{vis:o,from:i,to:a,query:t,filters:n}}function p(e){const t=function(e){switch(e){case"average":return b.b.MEAN;case"count":return b.b.COUNT;case"max":return b.b.MAX;case"median":return b.b.MEDIAN;case"min":return b.b.MIN;case"sum":return b.b.SUM;case"unique_count":return b.b.DISTINCT_COUNT;default:return null}}(e);if(null===t)throw Error(l.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.incorrectFunction",{defaultMessage:"Selected function {operationType} is not supported by anomaly detection detectors",values:{operationType:e}}));return t}async function m(e){const t=e.state.visualization;return"lnsXY"===e.visualizationType&&t.layers.some((e=>e.layerType===o.layerTypes.DATA))}function T(e){return function(e){return"seriesType"in e}(e)&&e.layerType===y&&_.includes(e.seriesType)}async function O(e,t,n){const{vis:r}=E(e);return async function(e,t,n){const r=e.state.visualization,a=await async function(e){const t=await e.getXyVisTypes();return e=>{var n;switch(e.layerType){case o.layerTypes.DATA:const r=t.find((t=>t.id===e.seriesType));return{label:(null==r?void 0:r.fullLabel)||(null==r?void 0:r.label)||e.layerType,icon:null!==(n=null==r?void 0:r.icon)&&void 0!==n?n:""};case o.layerTypes.ANNOTATIONS:return{label:l.i18n.translate("xpack.ml.newJob.fromLens.createJob.VisType.annotations",{defaultMessage:"Annotations"}),icon:""};case o.layerTypes.REFERENCELINE:return{label:l.i18n.translate("xpack.ml.newJob.fromLens.createJob.VisType.referenceLine",{defaultMessage:"Reference line"}),icon:""};default:return{label:e.layerType,icon:""}}}}(n);return await Promise.all(r.layers.filter((({layerType:e})=>e===o.layerTypes.DATA)).map((async n=>{const{icon:r,label:i}=a(n);try{const{fields:a,splitField:o}=await v(n,e,t),l=I(a,o),s=o||l.length>1?u.a.MULTI_METRIC:u.a.SINGLE_METRIC;return{id:n.layerId,layerType:n.layerType,label:i,icon:r,jobWizardType:s,isCompatible:!0}}catch(e){return{id:n.layerId,layerType:n.layerType,label:i,icon:r,jobWizardType:null,isCompatible:!1,error:e}}})))}(r,t,n)}async function v(e,t,n){var r;if(!T(e))throw Error(l.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.incompatibleLayerType",{defaultMessage:"Layer is incompatible. Only chart layers can be used."}));const a=t.state.datasourceStates.indexpattern,i=Object.entries(a.layers).find((([t])=>e.layerId===t));if(void 0===i)throw Error(l.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.noCompatibleLayers",{defaultMessage:"Visualization does not contain any layers which can be used for creating an anomaly detection job."}));const[o,s]=i,c=function({columns:e},t){if(t.accessors.forEach((t=>{const n=e[t];return"date"!==n.dataType&&p(n.operationType)})),Object.values(e).some((e=>0=="sourceField"in e)))throw Error(l.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.colsNoSourceField",{defaultMessage:"Some columns do not contain a source field."}));if(Object.values(e).some((e=>{return 1==("timeShift"in(t=e)||"filter"in t);var t})))throw Error(l.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.colsUsingFilterTimeSift",{defaultMessage:"Columns contain settings which are incompatible with ML detectors, time shift and filter by are not supported."}));return e}(s,e),u=Object.values(c).find((({dataType:e})=>"date"===e));if(void 0===u)throw Error(l.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.noDateField",{defaultMessage:"Cannot find a date field."}));const d=e.accessors.map((e=>c[e])),f=e.splitAccessor?c[e.splitAccessor]:null;if(null!==f&&"terms"===(b=f).operationType&&"params"in b&&null!==(r=f.params.secondaryFields)&&void 0!==r&&r.length)throw Error(l.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.splitFieldHasMultipleFields",{defaultMessage:"Selected split field contains more than one field."}));var b;if(null!==f&&!1===function(e){return g.includes(e.dataType)}(f))throw Error(l.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.splitFieldMustBeString",{defaultMessage:"Selected split field type must be string."}));const _=await async function(e,t,n){const r=e.find((e=>"index-pattern"===e.type&&e.name===`indexpattern-datasource-layer-${t}`));return r?n.get(r.id):null}(t.references,o,n);if(null===_)throw Error(l.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.noDataViews",{defaultMessage:"No data views can be found in the visualization."}));if(u.sourceField!==_.timeFieldName)throw Error(l.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.timeFieldNotInDataView",{defaultMessage:"Selected time field must be the default time field configured for data view."}));return{fields:d,timeField:u,splitField:f,dataView:_}}function I(e,t){return e.map((({operationType:e,sourceField:n})=>({function:p(e),field_name:n,...t?{partition_field_name:t.sourceField}:{}})))}var N=n(26);async function h(e,t,n,r,o,f,b){let _,y,g,E,p,m;if(e)_=await async function(e){const t=Object(N.i)();return(await t.get("lens",e)).attributes}(e);else{if(!t)throw new Error("Cannot create visualization");_=a.a.decode(t)}try{y=a.a.decode(o)}catch(e){y=Object(d.d)()}try{g=a.a.decode(f)}catch(e){g=[]}try{E=a.a.decode(n)}catch(e){E=""}try{p=a.a.decode(r)}catch(e){p=""}try{m=a.a.decode(b)}catch(e){m=void 0}const O=Object(N.c)(),h=Object(N.m)(),S=Object(N.k)();await async function(e,t,n,r,a,o,f,b,_){try{const{jobConfig:y,datafeedConfig:g,createdBy:E}=await async function(e,t,n,r,a,o){const l=e.state.visualization,c=l.layers.filter(T),f=void 0!==o?l.layers[o]:c[0],{fields:b,timeField:_,splitField:y,dataView:g}=await v(f,e,r),E=Object(s.c)(),p=Object(s.b)(g.title),m=function(e,t,n,r){const{combinedQuery:a}=Object(d.a)({query:e.query,filter:e.filters},n,r),{combinedQuery:o}=Object(d.a)({query:t.query,filter:t.filters},n,r);return Object(i.mergeWith)(a,o,((e,t)=>{if(Array.isArray(e))return e.concat(t)}))}({query:t,filters:n},{query:e.state.query,filters:e.state.filters},g,a);return p.query=m,E.analysis_config.detectors=I(b,y),E.data_description.time_field=_.sourceField,E.analysis_config.bucket_span=u.b,y&&(E.analysis_config.influencers=[y.sourceField]),{jobConfig:E,datafeedConfig:p,createdBy:y||E.analysis_config.detectors.length>1?u.a.MULTI_METRIC:u.a.SINGLE_METRIC}}(e,r,a,o,f,_);let p,m,O=!0;try{const{min:e,max:r}=b.calculateBounds({to:n,from:t});if(p=null==e?void 0:e.valueOf(),m=null==r?void 0:r.valueOf(),void 0===p||void 0===m||isNaN(p)||isNaN(m))throw Error(l.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.timeRange",{defaultMessage:"Incompatible time range"}))}catch(e){console.error(e),O=!1,p=void 0,m=void 0}Object(c.n)({jobConfig:y,datafeedConfig:g,createdBy:E,start:p,end:m},!0,O,!O)}catch(e){console.error(e)}}(_,E,p,y,g,O,h,S,m)}var S=n(0);async function w(e,t,n){const{query:r,filters:a,to:i,from:o,vis:l}=E(e),s=t.url.locators.get(S.a),c=await(null==s?void 0:s.getUrl({page:S.b.ANOMALY_DETECTION_CREATE_JOB_FROM_LENS,pageState:{vis:l,from:o,to:i,query:r,filters:a,layerIndex:n}}));window.open(c,"_blank")}},95:function(e,t,n){"use strict";n.d(t,"j",(function(){return d})),n.d(t,"g",(function(){return f})),n.d(t,"h",(function(){return b})),n.d(t,"f",(function(){return _})),n.d(t,"k",(function(){return g})),n.d(t,"n",(function(){return E})),n.d(t,"e",(function(){return p})),n.d(t,"d",(function(){return m})),n.d(t,"l",(function(){return T})),n.d(t,"m",(function(){return O})),n.d(t,"a",(function(){return v})),n.d(t,"b",(function(){return I})),n.d(t,"i",(function(){return N})),n.d(t,"c",(function(){return h}));var r=n(2),a=n(46),i=n(104),o=n(96),l=n(133),s=n(122),c=n(87),u=n(85);function d(e,t,n,r=!1){const a=r?function(e,t){return y(e.analysis_config.detectors)}(e):function(e,t){let n=e.analysis_config.detectors;const r=g(e,t);if(void 0!==t.aggregations&&e.analysis_config.detectors[0].function===o.b.NON_ZERO_COUNT&&!1===r){var a,i,l,c,u;const e=null==t||null===(a=t.aggregations)||void 0===a||null===(i=a.buckets)||void 0===i||null===(l=i.aggregations)||void 0===l||null===(c=l.dc_region)||void 0===c||null===(u=c.cardinality)||void 0===u?void 0:u.field;void 0!==e&&(n=[{function:o.b.DISTINCT_COUNT,field_name:e}])}else n=y(n),n=n.map((e=>{switch(e.function){case o.b.NON_ZERO_COUNT:return{...e,field_name:s.a,function:o.b.COUNT};case o.b.HIGH_NON_ZERO_COUNT:return{...e,field_name:s.a,function:o.b.HIGH_COUNT};case o.b.LOW_NON_ZERO_COUNT:return{...e,field_name:s.a,function:o.b.LOW_COUNT};case o.b.NON_NULL_SUM:return{...e,function:o.b.SUM};case o.b.HIGH_NON_NULL_SUM:return{...e,function:o.b.HIGH_SUM};case o.b.LOW_NON_NULL_SUM:return{...e,function:o.b.LOW_SUM};default:return e}}));return n}(e,t),c=(e=>t=>{let n=i.a.getFieldById(t);return null===n&&(t===l.b?n=s.c:e.length&&(n=e.find((e=>e.id===t))||null)),n})(n);return a.map((e=>{var t,n,r;let a=null,o=null,l=null,s=null;return void 0!==e.field_name&&(a=c(e.field_name)),void 0!==e.by_field_name&&(o=c(e.by_field_name)),void 0!==e.over_field_name&&(l=c(e.over_field_name)),void 0!==e.partition_field_name&&(s=c(e.partition_field_name)),{agg:i.a.getAggById(e.function),field:a,byField:o,overField:l,partitionField:s,excludeFrequent:null!==(t=e.exclude_frequent)&&void 0!==t?t:null,description:null!==(n=e.detector_description)&&void 0!==n?n:null,useNull:null!==(r=e.use_null)&&void 0!==r?r:null}}))}function f(e,t){return[...e.filter((e=>e.id!==s.a)).map((e=>({label:e.name}))),...t.filter((t=>!1===e.some((e=>e.id===t.id)))).map((e=>({label:e.id})))].sort(((e,t)=>e.label.localeCompare(t.label)))}function b(e){return null===e?[]:[{label:l.b}]}function _(e){return e?[{label:l.a}]:[{label:l.d}]}function y(e){return e.map((e=>{switch(e.function){case o.b.COUNT:case o.b.HIGH_COUNT:case o.b.LOW_COUNT:case o.b.NON_ZERO_COUNT:case o.b.HIGH_NON_ZERO_COUNT:case o.b.LOW_NON_ZERO_COUNT:case o.b.RARE:case o.b.FREQ_RARE:case o.b.TIME_OF_DAY:case o.b.TIME_OF_WEEK:return{...e,field_name:s.a};default:return e}}))}function g(e,t){var n,r,a,i,l;const s=e.analysis_config.detectors;if(void 0===(null==t||null===(n=t.aggregations)||void 0===n||null===(r=n.buckets)||void 0===r||null===(a=r.aggregations)||void 0===a||null===(i=a.dc_region)||void 0===i||null===(l=i.cardinality)||void 0===l?void 0:l.field))for(const e of s)if(o.c.includes(e.function))return!0;return!1}function E(e,t=!1,n=!1,r=!1){var a;c.a.tempJobCloningObjects.job=e.jobConfig,c.a.tempJobCloningObjects.datafeed=e.datafeedConfig,c.a.tempJobCloningObjects.createdBy=null!==(a=e.createdBy)&&void 0!==a?a:void 0,c.a.tempJobCloningObjects.skipTimeRangeStep=t,!0===n&&!1===r?(c.a.tempJobCloningObjects.start=e.start,c.a.tempJobCloningObjects.end=e.end):!0===r&&(c.a.tempJobCloningObjects.autoSetTimeRange=!0),c.a.tempJobCloningObjects.calendars=e.calendars}function p(e,t){e.createdBy=u.a.MULTI_METRIC,e.modelPlot=!1,E(e,!0,!0),t(`jobs/new_job/${u.f.MULTI_METRIC}`,!0)}function m(e,t){e.createdBy=null,E(e,!0,!0),t(`jobs/new_job/${u.f.ADVANCED}`,!0)}function T(e,t){e.createdBy=null,E(e,!0,!1),t("/jobs/new_job")}function O(e,t){e.jobId="",E(e,!0,!0),t("/jobs/new_job")}function v(e,t){null!==e&&E(e,!1,!1),t("/jobs")}function I(e){return!1===e.some((e=>null===e.agg.dslName))}function N(e){switch(e.type){case u.f.SINGLE_METRIC:return r.i18n.translate("xpack.ml.newJob.wizard.jobCreatorTitle.singleMetric",{defaultMessage:"Single metric"});case u.f.MULTI_METRIC:return r.i18n.translate("xpack.ml.newJob.wizard.jobCreatorTitle.multiMetric",{defaultMessage:"Multi-metric"});case u.f.POPULATION:return r.i18n.translate("xpack.ml.newJob.wizard.jobCreatorTitle.population",{defaultMessage:"Population"});case u.f.ADVANCED:return r.i18n.translate("xpack.ml.newJob.wizard.jobCreatorTitle.advanced",{defaultMessage:"Advanced"});case u.f.CATEGORIZATION:return r.i18n.translate("xpack.ml.newJob.wizard.jobCreatorTitle.categorization",{defaultMessage:"Categorization"});case u.f.RARE:return r.i18n.translate("xpack.ml.newJob.wizard.jobCreatorTitle.rare",{defaultMessage:"Rare"});default:return""}}function h(e,t){for(const n in e)null!==e[n]&&"object"==typeof e[n]&&("aggregations"!==n&&"aggs"!==n||Object.keys(e[n]).forEach((e=>{"aggregations"!==e&&"aggs"!==e&&t.push({id:e,name:e,type:a.ES_FIELD_TYPES.KEYWORD,aggregatable:!0})})),h(e[n],t))}}}]);