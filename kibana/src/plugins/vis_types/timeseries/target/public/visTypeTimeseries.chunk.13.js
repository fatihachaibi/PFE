(window.visTypeTimeseries_bundle_jsonpfunction=window.visTypeTimeseries_bundle_jsonpfunction||[]).push([[13],{202:function(e,n,l){"use strict";l.r(n),l.d(n,"triggerTSVBtoLensConfiguration",(function(){return F}));var t=l(4),i=l(12),r=l(0);const a=async(e,n,l,t)=>{const a=Object(r.d)();let u=e&&!Object(i.d)(e)?e.id:"",s=n;if(l){const{indexPattern:e}=await Object(i.b)(t,a);var o;e&&(u=null!==(o=e.id)&&void 0!==o?o:"",s=e.timeFieldName)}if(!u){var c;const e=await a.getDefault();u=null!==(c=null==e?void 0:e.id)&&void 0!==c?c:"",s=null==e?void 0:e.timeFieldName}return s||(s=(await a.get(u)).timeFieldName),{indexPatternId:u,timeField:s}},u=async(e,n)=>{const l=Object(r.d)(),t=await l.get(e),i=await t.getFieldByName(n);return null==i?void 0:i.type},s={avg:{name:"average",isFullReference:!1},cardinality:{name:"unique_count",isFullReference:!1},count:{name:"count",isFullReference:!1},positive_rate:{name:"counter_rate",isFullReference:!0},moving_average:{name:"moving_average",isFullReference:!0},derivative:{name:"differences",isFullReference:!0},cumulative_sum:{name:"cumulative_sum",isFullReference:!0},avg_bucket:{name:"overall_average",isFullReference:!0},max_bucket:{name:"overall_max",isFullReference:!0},min_bucket:{name:"overall_min",isFullReference:!0},sum_bucket:{name:"overall_sum",isFullReference:!0},max:{name:"max",isFullReference:!1},min:{name:"min",isFullReference:!1},percentile:{name:"percentile",isFullReference:!1},sum:{name:"sum",isFullReference:!1},filter_ratio:{name:"filter_ratio",isFullReference:!1},top_hit:{name:"last_value",isFullReference:!1},math:{name:"formula",isFullReference:!0},positive_only:{name:"clamp",isFullReference:!0},static:{name:"static_value",isFullReference:!0}},o=e=>[{agg:"formula",isFullReference:!0,fieldName:"document",params:{formula:e}}],c=e=>{const n=s[e.type];return n?n.name:null},d=e=>{let n;return e.unit&&["1s","1m","1h","1d"].includes(e.unit)&&(n=e.unit.replace("1","")),n},m=(e,n,l,t,i)=>{const r=s[e];if("filter_ratio"===l.type){const e=_(l);if(!e)return null;const n=`${r.name}(${e})`;return o(n)}const a=d(n);return[{agg:r.name,isFullReference:r.isFullReference,pipelineAggType:t,fieldName:null!=l&&l.field&&"count"!==t?null==l?void 0:l.field:"document",params:{...n.window&&{window:n.window},...a&&{timeScale:a},..."percentile"===t&&i&&{percentile:i}}}]},f=(e,n,l,t,i)=>{var r;let a="";const u=s[t],o=n.field,[c,d]=null!==(r=null==o?void 0:o.split("["))&&void 0!==r?r:[],m=e.find((e=>e.id===c));if(m){var f,p;const e=s[m.type];if(!e)return null;const n=Number(null==d?void 0:d.replace("]","")),i=s[t];let r;"percentile"===e.name&&n&&(r=`, percentile=${n}`),a=`${i.name}(${l}(${e.name}(${null!==(f=m.field)&&void 0!==f?f:""}${null!==(p=r)&&void 0!==p?p:""})))`}else{let e;if("percentile"===l&&i&&(e=`, percentile=${i}`),"filter_ratio"===l){var v;const l=_(n);if(!l)return null;a=`${u.name}(${l}${null!==(v=e)&&void 0!==v?v:""})`}else a="counter_rate"===l?`${u.name}(${l}(max(${n.field}${e?`${e}`:""})))`:`${u.name}(${l}(${n.field}${e?`${e}`:""}))`}return a},p=(e,n,l)=>{const t=l.find((e=>e.id===n.field));if(!t||"static"===t.type)return null;const i=s[t.type];if(!i)return null;const r=s[e],a="count"!==t.type?t.field:"",u=l.find((e=>e.id===a));let o=`${r.name}(`,c="";if(u){const e=s[u.type];if(!e)return null;const l="count"!==u.type?u.field:"";"positive_only"===n.type&&(c=`, 0, ${i.name}(${e.name}(${null!=l?l:""}))`),o+=`${i.name}(${e.name}(${null!=l?l:""}))${c})`}else"positive_only"===n.type&&(c=`, 0, ${i.name}(${null!=a?a:""})`),o+=`${i.name}(${null!=a?a:""})${c})`;return o},v=(e,n)=>{var l,t;return`${e}${"lucene"===(null==n?void 0:n.language)?"lucene":"kql"}='${null!=n&&n.query&&"string"==typeof(null==n?void 0:n.query)?(t=null==n?void 0:n.query,null==t?void 0:t.replace(/'/g,"\\'")):null!==(l=null==n?void 0:n.query)&&void 0!==l?l:"*"}')`},_=e=>{const{numerator:n,denominator:l,metric_agg:t,field:i}=e;let r=s.count;if(t&&(r=s[t],!r))return null;const a=t&&"count"!==t?`${r.name}('${i}',`:"count(";return"counter_rate"===r.name?`${v(`${r.name}(max('${i}',`,n)}) / ${v(`${r.name}(max('${i}',`,l)})`:`${v(a,n)} / ${v(a,l)}`},g=(e,n,l)=>{var t;const i=null===(t=s[e.type])||void 0===t?void 0:t.name;switch(e.type){case"avg_bucket":case"max_bucket":case"min_bucket":case"sum_bucket":case"positive_only":return p(e.type,e,n);case"count":return`${i}()`;case"percentile":return`${i}(${e.field}${l?`, percentile=${l}`:""})`;case"cumulative_sum":case"derivative":case"moving_average":{var r,a;const[t,i]=null!==(r=null==e||null===(a=e.field)||void 0===a?void 0:a.split("["))&&void 0!==r?r:[],u=n.find((e=>e.id===t));if(!u)return null;const s=c(u);return s?f(n,u,s,e.type,l):null}case"positive_rate":return`${i}(max(${e.field}))`;case"filter_ratio":return _(e);case"static":return`${e.value}`;default:return`${i}(${e.field})`}},b=(e,n)=>{const l=e.length-1,t=e[l].type,i=e[l].field,r=s[t];if(!r)return null;let a=[];switch(t){case"percentile":{const n=e[l].percentiles;if(null!=n&&n.length){const e=((e,n)=>null==e?void 0:e.map((e=>({agg:"percentile",isFullReference:!1,color:e.color,fieldName:null!=n?n:"document",params:{percentile:e.value}}))))(n,i);a=[...a,...e]}break}case"math":{const n=e.findIndex((e=>"math"===e.type));let l=e[n].script;const t=e[n].variables,i=e;if(!l||!t)return null;const r=i.filter((e=>"math"!==e.type));for(let n=0;n<r.length;n++){const r=e[n];if("top_hit"===r.type&&null!=r&&r.size&&1!==Number(null==r?void 0:r.size)||"asc"===(null==r?void 0:r.order))return null;if("percentile"===r.type)t.forEach((e=>{var n,t,a;const[u,s]=null!==(n=null==e||null===(t=e.field)||void 0===t?void 0:t.split("["))&&void 0!==n?n:[],o=Number(null==s?void 0:s.replace("]",""));if(!o)return;const c=g(r,i,o);c&&(l=null===(a=l)||void 0===a?void 0:a.replace(`params.${e.name}`,c))}));else{var u;const e=g(r,i);if(!e)return null;const n=t.find((e=>e.field===r.id));l=null===(u=l)||void 0===u?void 0:u.replaceAll(`params.${null==n?void 0:n.name}`,e)}}const s=isNaN(Number(l));if(l.includes("params")||!s)return null;a=o(l);break}case"moving_average":case"derivative":a=((e,n,l)=>{var t,i,r;const a=l[n],[u,s]=null!==(t=null==a||null===(i=a.field)||void 0===i?void 0:i.split("["))&&void 0!==t?t:[],d=l.find((e=>e.id===u));if(!d||"static"===d.type)return null;const p=c(d);if(!p)return null;const v=Number(null==s?void 0:s.replace("]","")),_=d.field,[g,b]=null!==(r=null==_?void 0:_.split("["))&&void 0!==r?r:[];if(l.find((e=>e.id===g))){const n=f(l,d,p,e,v);return n?o(n):null}return m(e,a,d,p,v)})(t,l,e);break;case"cumulative_sum":{var v,b,y;const[n,i]=null!==(v=null===(b=e[l])||void 0===b||null===(y=b.field)||void 0===y?void 0:y.split("["))&&void 0!==v?v:[],r=e.find((e=>e.id===n));if(!r||"static"===r.type)return null;const u=c(r);if(!u)return null;if("count"!==u&&"sum"!==u){const n=Number(null==i?void 0:i.replace("]","")),l=f(e,r,u,t,n);if(!l)return null;a=o(l)}else{const n=m(t,e[l],r,u);if(!n)return null;a=n}break}case"positive_only":{const n=p(t,e[l],e);if(!n)return null;a=o(n);break}case"avg_bucket":case"max_bucket":case"min_bucket":case"sum_bucket":{const n=p(t,e[l],e);if(!n)return null;a=o(n);break}case"filter_ratio":{const n=_(e[l]);if(!n)return null;a=o(n);break}case"top_hit":{const n=e[l];if(null!=n&&n.size&&1!==Number(null==n?void 0:n.size)||"asc"===(null==n?void 0:n.order))return null;const t=d(n);a=[{agg:r.name,isFullReference:r.isFullReference,fieldName:null!=i?i:"document",params:{...t&&{timeScale:t},...(null==n?void 0:n.order_by)&&{sortField:null==n?void 0:n.order_by}}}];break}case"static":{if(1===n)return null;const t=e[l].value;a=[{agg:r.name,isFullReference:r.isFullReference,fieldName:"document",params:{...t&&{value:t}}}];break}default:{const n=d(e[l]);a=[{agg:r.name,isFullReference:r.isFullReference,fieldName:"count"!==t&&i?i:"document",params:{...n&&{timeScale:n}}}]}}return a},y=(e,n,l)=>(n?Number(e.axis_min)<n&&(n=Number(e.axis_min)):n=Number(e.axis_min),l?Number(e.axis_max)>l&&(l=Number(e.axis_max)):l=Number(e.axis_max),{lowerBound:n,upperBound:l}),$=(e,n,l)=>{return t=e,i=n,l&&t&&t>0||i&&i<0?0:e;var t,i};var x=l(50);const h=["bytes","percent","number"],F=async e=>{var n,l,i;if(e.type!==t.e.TIMESERIES||!e.use_kibana_indexes||e.annotations&&e.annotations.length>0)return null;const r={};let s=0;e.series.forEach((e=>{e.hidden||s++}));for(let n=0;n<e.series.length;n++){var o,c,d;const l=e.series[n];if(l.hidden)continue;const{indexPatternId:t,timeField:i}=await a(e.index_pattern,e.time_field,Boolean(l.override_index_pattern),l.series_index_pattern),m=l.offset_time,f="line"===l.chart_type&&Number(l.fill)>0?"area":l.chart_type;let p=f;"none"!==l.stacked&&"percent"!==l.stacked&&(p="line"!==f?`${f}_stacked`:"line"),"percent"===l.stacked&&(p="line"!==f?`${f}_percentage_stacked`:"line");let v,_=b(l.metrics,s);if(!_)return null;l.filter&&("kuery"===l.filter.language?v={kql:l.filter.query}:"lucene"===l.filter.language&&(v={lucene:l.filter.query})),_=_.map((e=>{var n;return{...e,color:null!==(n=e.color)&&void 0!==n?n:l.color,params:{...e.params,...m&&{shift:m},...v&&v}}}));const g=[];"filter"===l.split_mode&&l.filter&&g.push({filter:l.filter}),l.split_filters&&g.push(...l.split_filters);const y=l.palette,$=Object(x.d)(l.terms_field);let F=!1;if(l.terms_field&&"terms"===l.split_mode&&$)for(const e of $)if("date"===await u(t,e)){if(1!==$.length)return null;F=!0}const N={indexPatternId:t,timeFieldName:i,chartType:p,axisPosition:l.separate_axis?l.axis_position:e.axis_position,...l.terms_field&&{splitFields:$},splitWithDateHistogram:F,..."everything"!==l.split_mode&&{splitMode:l.split_mode},...g.length>0&&{splitFilters:g},palette:y&&"gradient"!==y.name&&"rainbow"!==y.name?y:{name:"default",type:"palette"},..."terms"===l.split_mode&&{termsParams:{size:null!==(o=l.terms_size)&&void 0!==o?o:10,otherBucket:!1,orderDirection:null!==(c=l.terms_direction)&&void 0!==c?c:"desc",orderBy:"_key"===l.terms_order_by?{type:"alphabetical"}:{type:"column"},parentFormat:{id:"terms"}}},metrics:[..._],timeInterval:!e.interval||null!==(d=e.interval)&&void 0!==d&&d.includes("=")?"auto":e.interval,...h.includes(l.formatter)&&{format:l.formatter},...l.label&&{label:l.label},dropPartialBuckets:l.override_index_pattern?l.series_drop_last_bucket>0:e.drop_last_bucket>0};r[n]=N}const m=(e=>{let n=null,l=null,t=null,i=null,r=!1,a=!1,u=!1,s=!1;e.series.forEach((e=>{if("left"===e.axis_position&&(("line"!==e.chart_type||"line"===e.chart_type&&Number(e.fill)>0)&&(u=!0),e.separate_axis)){r=!0;const{lowerBound:t,upperBound:i}=y(e,n,l);n=t,l=i}if("right"===e.axis_position&&e.separate_axis&&(("line"!==e.chart_type||"line"===e.chart_type&&Number(e.fill)>0)&&(s=!0),e.separate_axis)){a=!0;const{lowerBound:n,upperBound:l}=y(e,t,i);t=n,i=l}}));const o=r?$(n,l,u):"left"===e.axis_position?$(Number(e.axis_min),Number(e.axis_max),u):null,c=r?l:"left"===e.axis_position?e.axis_max:null,d=a?$(t,i,s):"right"===e.axis_position?e.axis_min:null,m=a?i:"right"===e.axis_position?$(Number(e.axis_min),Number(e.axis_max),s):null;return{yLeftExtent:{...o&&{lowerBound:Number(o)},...c&&{upperBound:Number(c)},mode:o||c?"custom":"full"},yRightExtent:{...d&&{lowerBound:Number(m)},...m&&{upperBound:Number(m)},mode:d||m?"custom":"full"}}})(e);return{layers:r,type:"lnsXY",configuration:{fill:null!==(n=e.series[0].fill)&&void 0!==n?n:.3,legend:{isVisible:Boolean(e.show_legend),showSingleSeries:Boolean(e.show_legend),position:null!==(l=e.legend_position)&&void 0!==l?l:"right",shouldTruncate:Boolean(e.truncate_legend),maxLines:null!==(i=e.max_lines_legend)&&void 0!==i?i:1},gridLinesVisibility:{x:Boolean(e.show_grid),yLeft:Boolean(e.show_grid),yRight:Boolean(e.show_grid)},extents:m}}}},50:function(e,n,l){"use strict";l.d(n,"c",(function(){return a})),l.d(n,"f",(function(){return u})),l.d(n,"d",(function(){return s})),l.d(n,"e",(function(){return o})),l.d(n,"b",(function(){return c})),l.d(n,"a",(function(){return d}));var t=l(2),i=l(29),r=l(19);const a=(e,n,l=!0)=>{if(e.length&&n){const t=e.find((e=>e.name===n));if(t)return t.label||t.name;if(l)throw new r.b(n)}return n},u=e=>e.filter((e=>e.aggregatable&&!Object(i.isNestedField)(e))).map((e=>{var n;return{name:e.name,label:null!==(n=e.customLabel)&&void 0!==n?n:e.name,type:e.type}})),s=e=>e?[e].flat().filter(Boolean):[],o=(e,n)=>{const l=n?a(n,e[0]):e[0];return e.length>1?t.i18n.translate("visTypeTimeseries.fieldUtils.multiFieldLabel",{defaultMessage:"{firstFieldLabel} + {count} {count, plural, one {other} other {others}}",values:{firstFieldLabel:l,count:e.length-1}}):null!=l?l:""},c=(e,n,l,t,i=[])=>{const r=new Map;return(a,u,s="text")=>{var o,c;const d=r.get(a),m=e=>e.convert(u,s,t?{timezone:t.timezone}:void 0);if(d)return m(d);if(e&&!i.includes(null===(o=e.fieldFormatMap)||void 0===o||null===(c=o[a])||void 0===c?void 0:c.id)){const n=e.fields.getByName(a);if(n){const l=e.getFormatterForField(n);if(l)return r.set(a,l),m(l)}}else if(l&&n){const e=n.find((e=>e.name===a));if(e){const n=l.getDefaultInstance(e.type);if(n)return r.set(a,n),m(n)}}}},d=" › "}}]);